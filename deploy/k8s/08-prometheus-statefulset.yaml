---
# Prometheus StatefulSet (2 replicas for HA)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    app: prometheus
spec:
  serviceName: prometheus
  replicas: 2
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
        tier: observability
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: prometheus
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
      
      affinity:
        # Spread replicas across different nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - prometheus
                topologyKey: kubernetes.io/hostname
        # Prefer nodes with higher compute resources
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 50
              preference:
                matchExpressions:
                  - key: node.kubernetes.io/instance-type
                    operator: In
                    values:
                      - t3.large
                      - t3.xlarge
                      - m5.large
                      - m5.xlarge
      
      # Init container to fix permissions
      initContainers:
        - name: fix-permissions
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              mkdir -p /prometheus/wal
              chown -R 65534:65534 /prometheus
          volumeMounts:
            - name: storage
              mountPath: /prometheus
      
      containers:
        - name: prometheus
          image: prom/prometheus:v2.48.0
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 9090
              protocol: TCP
          
          args:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=30d"
            - "--storage.tsdb.retention.size=190GB"
            - "--web.enable-lifecycle"
            - "--web.enable-admin-api"
            - "--query.max-samples=100000000"
            - "--log.level=info"
          
          env:
            - name: PROMETHEUS_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: PROMETHEUS_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          
          resources:
            requests:
              memory: "8Gi"
              cpu: "2"
            limits:
              memory: "16Gi"
              cpu: "4"
          
          # Health checks
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: 9090
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            httpGet:
              path: /-/ready
              port: 9090
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Security context
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          
          volumeMounts:
            - name: config
              mountPath: /etc/prometheus
            - name: rules
              mountPath: /etc/prometheus/rules
            - name: storage
              mountPath: /prometheus
            - name: tmp
              mountPath: /tmp
      
      volumes:
        - name: config
          configMap:
            name: prometheus-config
            items:
              - key: prometheus.yml
                path: prometheus.yml
        - name: rules
          projected:
            sources:
              - configMap:
                  name: prometheus-alert-rules
                  items:
                    - key: alert-rules.yml
                      path: alert-rules.yml
              - configMap:
                  name: prometheus-recording-rules
                  items:
                    - key: recording-rules.yml
                      path: recording-rules.yml
        - name: tmp
          emptyDir: {}
      
      # Graceful shutdown
      terminationGracePeriodSeconds: 300
      
      # Pod disruption budget for high availability
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - prometheus
                topologyKey: kubernetes.io/hostname
  
  # Persistent volume for TSDB storage
  volumeClaimTemplates:
    - metadata:
        name: storage
        labels:
          app: prometheus
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: monitoring-ssd
        resources:
          requests:
            storage: 200Gi
---
# Pod Disruption Budget for Prometheus
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: prometheus-pdb
  namespace: monitoring
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: prometheus
