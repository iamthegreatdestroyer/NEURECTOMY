---
# Loki ConfigMap for centralized log aggregation
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: monitoring
  labels:
    app: loki
    tier: observability
data:
  loki-config.yaml: |
    # ============================================================================
    # NEURECTOMY Loki Configuration - Phase 18E
    # Centralized logging system for 4 core services
    # ============================================================================

    auth_enabled: false

    server:
      http_listen_port: 3100
      grpc_listen_port: 9096
      log_level: info
      
      # Graceful shutdown settings
      graceful_shutdown_timeout: 30s
      http_server_write_timeout: 600s
      
      # Enable gzip compression
      http_server_read_timeout: 600s

    # Distributor settings (accepts writes)
    distributor:
      rate_limit_enabled: true
      rate_limit: 100000  # Lines per second
      rate_limit_burst: 200000
      max_streams_per_user: 10000
      max_global_streams_per_user: 10000

    # Ingester settings (in-memory storage)
    ingester:
      chunk_idle_period: 3m
      chunk_retain_period: 1m
      max_chunk_age: 1h
      chunk_encoding: snappy
      
      lifecycler:
        ring:
          kvstore:
            store: inmemory
          replication_factor: 1
        num_tokens: 128
        heartbeat_timeout: 5m
        join_after: 10s

    # Query settings
    querier:
      max_concurrent: 20
      query_timeout: 5m
      query_ingesters_within: 3h
      engine:
        timeout: 5m

    # Query range cache
    query_range:
      align_queries_with_step: true
      max_cache_freshness_per_query: 10m
      cache_results: true
      results_cache:
        cache:
          enable_fifocache: false
          default_validity: 1h
          background:
            writeback_goroutines: 10
            writeback_delay: 5s
          memcached_client:
            addresses: memcached:11211
            update_interval: 1m
            stale_ttl: 1h
            max_idle_conns: 100

    # Schema configuration
    schema_config:
      configs:
        - from: 2025-01-01
          store: boltdb-shipper
          object_store: s3
          schema: v13
          index:
            prefix: neurectomy_index_
            period: 24h

    # Storage backend configuration
    storage_config:
      # BoltDB Shipper for index storage
      boltdb_shipper:
        active_index_directory: /loki/boltdb-shipper-active
        cache_location: /loki/boltdb-shipper-cache
        shared_store: s3
        index_gateway_client:
          server_address: dns:///index-gateway.monitoring.svc.cluster.local:9096

      # S3 object storage for chunks
      aws:
        s3: s3://loki-data/chunks/
        endpoint: minio:9000  # Use MinIO or AWS S3
        insecure: true
        s3forcepathstyle: true
        access_key_id: ${AWS_ACCESS_KEY_ID}
        secret_access_key: ${AWS_SECRET_ACCESS_KEY}
        bucketnames: loki-chunks
        region: us-east-1

      # Index cache
      cache_config:
        enable_fifocache: false
        memcached_client:
          addresses: memcached:11211
          batch_size: 1024
          parallelism: 100
          max_idle_conns: 100
          update_interval: 1m

    # Limits configuration
    limits_config:
      # Per-stream label limits
      retention_period: 720h  # 30 days
      split_queries_by_interval: 24h
      max_streams_per_user: 10000
      max_global_streams_per_user: 10000
      max_entries_limit_per_minute: 1000000
      max_bytes_per_request: 10485760  # 10MB
      ingestion_rate_mb: 100
      ingestion_burst_size_mb: 200
      stream_limit_size_bytes: 10485760
      
      # Retention overrides per tenant
      retention_overrides:
        - selector: '{tier="debug"}'
          retention: 72h
        - selector: '{tier="prod"}'
          retention: 720h
        - selector: '{service="agents"}'
          retention: 1440h

    # Ruler for alerting rules
    ruler:
      enable_api: true
      enable_alertmanager_discovery: true
      alertmanager_url: http://alertmanager.monitoring.svc.cluster.local:9093
      external_url: http://loki:3100
      rule_path: /loki/rules
      polling_interval: 1m
      evaluation_interval: 1m
      rule_groups:
        - name: neurectomy_alerts
          interval: 1m
          rules:
            - alert: HighErrorRate
              expr: |
                rate(count_over_time({level="error"}[5m])) > 10
              for: 5m
              annotations:
                summary: "High error rate detected"
            
            - alert: ServiceHighLatency
              expr: |
                histogram_quantile(0.99, rate(request_duration_seconds_bucket[5m])) > 1
              for: 5m
              annotations:
                summary: "Service latency is high"

    # Table manager for retention
    table_manager:
      poll_interval: 10m
      retention_deletes_enabled: true
      retention_period: 0h  # Handled by retention_overrides

    # Memberlist for clustering
    memberlist:
      node_name: ${HOSTNAME}
      bind_port: 7946
      dead_node_reclaim_time: 30s
      gossip_interval: 1s
      gossip_nodes: 3
      gossip_to_nodes_fraction: 1.5
      retransmit_factor: 4

    # TracingConfig for observability
    tracing_config:
      enabled: true
      sampler:
        type: probabilistic
        param: 0.1
      jaeger:
        sampler:
          type: const
          param: 1
        reporter_log_spans: true
        endpoint: http://jaeger.monitoring.svc.cluster.local:14268/api/traces
