# ============================================================================
# NEURECTOMY - Prometheus Alert Rules for GitOps
# Alerting rules for Flux CD reconciliation and deployment status
# ============================================================================

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: flux-gitops-alerts
  namespace: flux-system
  labels:
    app.kubernetes.io/name: neurectomy
    app.kubernetes.io/component: alerting
    prometheus: neurectomy
    role: alert-rules
spec:
  groups:
    # ========================================================================
    # Flux Reconciliation Alerts
    # ========================================================================
    - name: flux.reconciliation
      interval: 30s
      rules:
        # Alert when Kustomization reconciliation fails
        - alert: FluxKustomizationReconciliationFailure
          expr: |
            gotk_reconcile_condition{type="Ready", status="False", kind="Kustomization"} == 1
          for: 15m
          labels:
            severity: critical
            team: platform
          annotations:
            summary: "Flux Kustomization {{ $labels.name }} reconciliation failed"
            description: "Kustomization {{ $labels.name }} in namespace {{ $labels.namespace }} has been failing to reconcile for more than 15 minutes."
            runbook_url: "https://docs.neurectomy.dev/runbooks/flux-reconciliation-failure"

        # Alert when GitRepository sync fails
        - alert: FluxGitRepositorySyncFailure
          expr: |
            gotk_reconcile_condition{type="Ready", status="False", kind="GitRepository"} == 1
          for: 10m
          labels:
            severity: warning
            team: platform
          annotations:
            summary: "Flux GitRepository {{ $labels.name }} sync failed"
            description: "GitRepository {{ $labels.name }} in namespace {{ $labels.namespace }} has been failing to sync for more than 10 minutes."
            runbook_url: "https://docs.neurectomy.dev/runbooks/flux-git-sync-failure"

        # Alert when reconciliation is suspended
        - alert: FluxReconciliationSuspended
          expr: |
            gotk_suspend_status{kind=~"Kustomization|GitRepository"} == 1
          for: 1h
          labels:
            severity: warning
            team: platform
          annotations:
            summary: "Flux {{ $labels.kind }} {{ $labels.name }} is suspended"
            description: "{{ $labels.kind }} {{ $labels.name }} has been suspended for more than 1 hour. Verify this is intentional."

    # ========================================================================
    # Flux Health Alerts
    # ========================================================================
    - name: flux.health
      interval: 1m
      rules:
        # Alert when Flux controllers are down
        - alert: FluxControllerDown
          expr: |
            up{job=~"source-controller|kustomize-controller|helm-controller|notification-controller"} == 0
          for: 5m
          labels:
            severity: critical
            team: platform
          annotations:
            summary: "Flux controller {{ $labels.job }} is down"
            description: "The Flux {{ $labels.job }} has been down for more than 5 minutes."
            runbook_url: "https://docs.neurectomy.dev/runbooks/flux-controller-down"

        # Alert on high reconciliation duration
        - alert: FluxReconciliationSlow
          expr: |
            histogram_quantile(0.99, sum(rate(gotk_reconcile_duration_seconds_bucket[5m])) by (le, kind, name)) > 300
          for: 15m
          labels:
            severity: warning
            team: platform
          annotations:
            summary: "Slow Flux reconciliation for {{ $labels.kind }} {{ $labels.name }}"
            description: "The 99th percentile reconciliation duration for {{ $labels.kind }} {{ $labels.name }} exceeds 5 minutes."

    # ========================================================================
    # Deployment Health Alerts
    # ========================================================================
    - name: flux.deployments
      interval: 1m
      rules:
        # Alert on production deployment failure
        - alert: ProductionDeploymentFailed
          expr: |
            gotk_reconcile_condition{type="Ready", status="False", kind="Kustomization", name="neurectomy-production"} == 1
          for: 5m
          labels:
            severity: critical
            team: platform
            environment: production
          annotations:
            summary: "üö® Production deployment failed"
            description: "The production Kustomization has been failing for more than 5 minutes. Immediate attention required."
            runbook_url: "https://docs.neurectomy.dev/runbooks/production-deployment-failure"

        # Alert on staging deployment failure
        - alert: StagingDeploymentFailed
          expr: |
            gotk_reconcile_condition{type="Ready", status="False", kind="Kustomization", name="neurectomy-staging"} == 1
          for: 10m
          labels:
            severity: warning
            team: platform
            environment: staging
          annotations:
            summary: "‚ö†Ô∏è Staging deployment failed"
            description: "The staging Kustomization has been failing for more than 10 minutes."

        # Alert on development deployment failure
        - alert: DevelopmentDeploymentFailed
          expr: |
            gotk_reconcile_condition{type="Ready", status="False", kind="Kustomization", name="neurectomy-development"} == 1
          for: 15m
          labels:
            severity: info
            team: platform
            environment: development
          annotations:
            summary: "‚ÑπÔ∏è Development deployment failed"
            description: "The development Kustomization has been failing for more than 15 minutes."

    # ========================================================================
    # Resource Drift Alerts
    # ========================================================================
    - name: flux.drift
      interval: 5m
      rules:
        # Alert on resource drift (pruning needed)
        - alert: FluxResourceDrift
          expr: |
            gotk_resource_info{prune="true", orphan="true"} == 1
          for: 30m
          labels:
            severity: warning
            team: platform
          annotations:
            summary: "Resource drift detected in {{ $labels.name }}"
            description: "Orphaned resources detected that should be pruned by Flux. Review before enabling prune."
