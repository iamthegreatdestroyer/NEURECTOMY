# ============================================================================
# NEURECTOMY - ML Service External Secrets
# Production-grade secret synchronization from cloud secret managers
# ============================================================================

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ml-service-secrets
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: ml-service
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: neurectomy-platform
spec:
  # How often to sync secrets from the provider
  refreshInterval: 1h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager # Change to azure-key-vault or gcp-secret-manager as needed

  # Target Kubernetes secret configuration
  target:
    name: ml-service-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: ml-service
          app.kubernetes.io/component: secrets
        annotations:
          reloader.stakater.com/match: "true" # Auto-reload deployments on secret change

  # Secret data mapping
  data:
    # Database connection string
    - secretKey: database-url
      remoteRef:
        key: neurectomy/ml-service/database
        property: connection-string

    # Redis connection
    - secretKey: redis-url
      remoteRef:
        key: neurectomy/ml-service/redis
        property: connection-string

    # JWT authentication secret
    - secretKey: jwt-secret
      remoteRef:
        key: neurectomy/ml-service/auth
        property: jwt-secret

    # MLflow tracking credentials
    - secretKey: mlflow-tracking-username
      remoteRef:
        key: neurectomy/ml-service/mlflow
        property: username

    - secretKey: mlflow-tracking-password
      remoteRef:
        key: neurectomy/ml-service/mlflow
        property: password

---
# Database credentials as separate secret (for operators that need them)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: neurectomy-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: postgres-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: neurectomy/database/postgres
        property: username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: neurectomy/database/postgres
        property: password
    - secretKey: POSTGRES_DB
      remoteRef:
        key: neurectomy/database/postgres
        property: database

---
# Neo4j credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: neo4j-credentials
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: neo4j
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: neurectomy-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: neo4j-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: NEO4J_AUTH
      remoteRef:
        key: neurectomy/database/neo4j
        property: auth-string

---
# API keys and external service credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: external-api-keys
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: ml-service
    app.kubernetes.io/component: api-keys
    app.kubernetes.io/part-of: neurectomy-platform
spec:
  refreshInterval: 30m
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: external-api-keys
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    # OpenAI API key (if using)
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: neurectomy/api-keys/openai
        property: api-key
    # Anthropic API key (if using Claude)
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: neurectomy/api-keys/anthropic
        property: api-key
    # GitHub token for integrations
    - secretKey: GITHUB_TOKEN
      remoteRef:
        key: neurectomy/api-keys/github
        property: token

---
# TLS certificates (for internal services)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: internal-tls-certs
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: neurectomy
    app.kubernetes.io/component: tls
    app.kubernetes.io/part-of: neurectomy-platform
spec:
  refreshInterval: 24h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: internal-tls-certs
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: neurectomy/tls/internal
        property: certificate
    - secretKey: tls.key
      remoteRef:
        key: neurectomy/tls/internal
        property: private-key
