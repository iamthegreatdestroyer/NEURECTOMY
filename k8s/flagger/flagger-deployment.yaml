# ============================================================================
# NEURECTOMY - Flagger Deployment
# Canary deployment controller using Flux source
# ============================================================================

# Note: Flagger is typically installed via Helm. This manifest shows the
# HelmRelease for Flux to manage Flagger installation.

apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: flagger
  namespace: flux-system
  labels:
    app.kubernetes.io/name: neurectomy
    app.kubernetes.io/component: flagger
spec:
  interval: 1h
  url: https://flagger.app
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flagger
  namespace: flagger-system
  labels:
    app.kubernetes.io/name: neurectomy
    app.kubernetes.io/component: flagger
spec:
  interval: 1h

  chart:
    spec:
      chart: flagger
      version: ">=1.30.0"
      sourceRef:
        kind: HelmRepository
        name: flagger
        namespace: flux-system
      interval: 1h

  values:
    # Controller settings
    logLevel: info

    # Metrics provider (Prometheus)
    metricsServer: http://prometheus-operated.monitoring:9090

    # Mesh provider (using Kubernetes native for now)
    meshProvider: kubernetes

    # Enable Slack notifications
    slack:
      url: "${SLACK_WEBHOOK_URL}"
      channel: neurectomy-deployments
      user: flagger

    # Pod settings
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Service account
    serviceAccount:
      create: true
      name: flagger

    # RBAC
    rbac:
      create: true
---
# ============================================================================
# Flagger Load Tester - for canary analysis
# ============================================================================
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flagger-loadtester
  namespace: flagger-system
  labels:
    app.kubernetes.io/name: neurectomy
    app.kubernetes.io/component: flagger-loadtester
spec:
  interval: 1h

  chart:
    spec:
      chart: loadtester
      version: ">=0.25.0"
      sourceRef:
        kind: HelmRepository
        name: flagger
        namespace: flux-system
      interval: 1h

  values:
    replicaCount: 1

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi
