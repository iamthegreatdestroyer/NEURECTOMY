# ============================================================================
# NEURECTOMY - Production Anti-Affinity Rules
# Spread pods across nodes and availability zones for HA
# ============================================================================

# Strategic patch for ml-service deployment to add anti-affinity
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-service
spec:
  template:
    spec:
      # Pod anti-affinity to spread replicas
      affinity:
        # Don't schedule multiple replicas on the same node
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: ml-service
                  environment: production
              topologyKey: kubernetes.io/hostname

          # Prefer spreading across availability zones
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: ml-service
                    environment: production
                topologyKey: topology.kubernetes.io/zone

        # Node affinity for production-labeled nodes (if used)
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 50
              preference:
                matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                      - production
                      - ml-workload

      # Tolerations for dedicated nodes
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "ml-service"
          effect: "NoSchedule"

      # Topology spread constraints for even distribution
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: ml-service
              environment: production
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: ml-service
              environment: production
