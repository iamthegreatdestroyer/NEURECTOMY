# ============================================================================
# NEURECTOMY - Service Account Hardening
# Dedicated service accounts with least-privilege IRSA bindings
# ============================================================================

# ML Service - Primary workload
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ml-service
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: ml-service
    app.kubernetes.io/part-of: neurectomy
  annotations:
    # AWS IRSA binding
    eks.amazonaws.com/role-arn: "${ML_SERVICE_IAM_ROLE_ARN}"
    # Audience restriction
    eks.amazonaws.com/audience: "sts.amazonaws.com"
    # STS regional endpoint for improved latency
    eks.amazonaws.com/sts-regional-endpoints: "true"
automountServiceAccountToken: false # Explicit opt-in required

---
# MLflow Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mlflow
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: mlflow
    app.kubernetes.io/part-of: neurectomy
  annotations:
    eks.amazonaws.com/role-arn: "${MLFLOW_IAM_ROLE_ARN}"
    eks.amazonaws.com/audience: "sts.amazonaws.com"
    eks.amazonaws.com/sts-regional-endpoints: "true"
automountServiceAccountToken: false

---
# PostgreSQL Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/part-of: neurectomy
  annotations:
    eks.amazonaws.com/role-arn: "${POSTGRES_IAM_ROLE_ARN}"
    eks.amazonaws.com/audience: "sts.amazonaws.com"
    eks.amazonaws.com/sts-regional-endpoints: "true"
automountServiceAccountToken: false

---
# Redis Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: redis
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/part-of: neurectomy
automountServiceAccountToken: false

---
# Prometheus Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: neurectomy
  annotations:
    eks.amazonaws.com/role-arn: "${PROMETHEUS_IAM_ROLE_ARN}"
    eks.amazonaws.com/audience: "sts.amazonaws.com"
automountServiceAccountToken: false

---
# Grafana Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: neurectomy
  annotations:
    eks.amazonaws.com/role-arn: "${GRAFANA_IAM_ROLE_ARN}"
    eks.amazonaws.com/audience: "sts.amazonaws.com"
automountServiceAccountToken: false

---
# RBAC - ML Service Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ml-service-role
  namespace: neurectomy
rules:
  # ConfigMaps - read only
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  # Secrets - read only for specific secrets
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["ml-service-secrets", "ml-service-tls"]
    verbs: ["get"]
  # Pods - for health checks
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

---
# RBAC - ML Service RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ml-service-rolebinding
  namespace: neurectomy
subjects:
  - kind: ServiceAccount
    name: ml-service
    namespace: neurectomy
roleRef:
  kind: Role
  name: ml-service-role
  apiGroup: rbac.authorization.k8s.io

---
# RBAC - MLflow Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: mlflow-role
  namespace: neurectomy
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["mlflow-secrets", "mlflow-tls"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: mlflow-rolebinding
  namespace: neurectomy
subjects:
  - kind: ServiceAccount
    name: mlflow
    namespace: neurectomy
roleRef:
  kind: Role
  name: mlflow-role
  apiGroup: rbac.authorization.k8s.io

---
# RBAC - Prometheus ClusterRole (needs cluster-wide access)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-cluster-role
rules:
  # Metrics endpoints
  - apiGroups: [""]
    resources: ["nodes", "nodes/metrics", "nodes/proxy"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["services", "endpoints", "pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get"]
  - nonResourceURLs: ["/metrics", "/metrics/cadvisor"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-cluster-rolebinding
subjects:
  - kind: ServiceAccount
    name: prometheus
    namespace: monitoring
roleRef:
  kind: ClusterRole
  name: prometheus-cluster-role
  apiGroup: rbac.authorization.k8s.io

---
# RBAC - Grafana Role (namespace-scoped)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: grafana-role
  namespace: monitoring
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: grafana-rolebinding
  namespace: monitoring
subjects:
  - kind: ServiceAccount
    name: grafana
    namespace: monitoring
roleRef:
  kind: Role
  name: grafana-role
  apiGroup: rbac.authorization.k8s.io

---
# Pod Security Policy alternative - Security Context Constraints
# Note: PSPs are deprecated, using SecurityContextConstraints pattern
apiVersion: v1
kind: ConfigMap
metadata:
  name: service-account-policies
  namespace: neurectomy
  labels:
    app.kubernetes.io/part-of: neurectomy
data:
  policies.yaml: |
    # Service account policies
    serviceAccounts:
      ml-service:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
      
      mlflow:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false  # MLflow needs write access
        capabilities:
          drop:
            - ALL
      
      postgres:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
      
      redis:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
