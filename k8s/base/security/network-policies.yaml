# ============================================================================
# NEURECTOMY - Enhanced Network Policies
# Comprehensive network segmentation with Kubernetes NetworkPolicy
# ============================================================================

# Default deny all ingress and egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: neurectomy
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: baseline
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

# Allow DNS resolution for all pods
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: neurectomy
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: baseline
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

# ML Service Network Policy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ml-service-network-policy
  namespace: neurectomy
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: workload
spec:
  podSelector:
    matchLabels:
      app: ml-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
      ports:
        - protocol: TCP
          port: 8000
    # Allow traffic from other ml-service pods (inter-replica communication)
    - from:
        - podSelector:
            matchLabels:
              app: ml-service
      ports:
        - protocol: TCP
          port: 8000
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 8000 # metrics endpoint
  egress:
    # Allow access to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow access to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow access to MLflow
    - to:
        - podSelector:
            matchLabels:
              app: mlflow
      ports:
        - protocol: TCP
          port: 5000
    # Allow access to external AI APIs (via egress gateway)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
      ports:
        - protocol: TCP
          port: 443

# PostgreSQL Network Policy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: neurectomy
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: database
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Only allow from ml-service and grafana
    - from:
        - podSelector:
            matchLabels:
              app: ml-service
        - podSelector:
            matchLabels:
              app: grafana
        - podSelector:
            matchLabels:
              app: mlflow
      ports:
        - protocol: TCP
          port: 5432
  egress:
    # PostgreSQL typically doesn't need egress except for DNS
    []

# Redis Network Policy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-network-policy
  namespace: neurectomy
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: cache
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Only allow from ml-service
    - from:
        - podSelector:
            matchLabels:
              app: ml-service
      ports:
        - protocol: TCP
          port: 6379
    # Allow Redis cluster communication (if using cluster mode)
    - from:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 16379 # cluster bus
  egress:
    # Redis cluster communication
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 16379

# MLflow Network Policy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mlflow-network-policy
  namespace: neurectomy
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: ml-platform
spec:
  podSelector:
    matchLabels:
      app: mlflow
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from ml-service for model registry access
    - from:
        - podSelector:
            matchLabels:
              app: ml-service
      ports:
        - protocol: TCP
          port: 5000
    # Allow from ingress for UI access
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 5000
  egress:
    # Allow access to PostgreSQL (MLflow backend store)
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow access to S3/MinIO for artifact storage
    - to:
        - podSelector:
            matchLabels:
              app: minio
      ports:
        - protocol: TCP
          port: 9000
    # Allow HTTPS egress for cloud storage (S3, GCS, Azure Blob)
    - ports:
        - protocol: TCP
          port: 443

# Grafana Network Policy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-network-policy
  namespace: monitoring
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from ingress for UI access
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3000
  egress:
    # Allow access to Prometheus
    - to:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090
    # Allow access to PostgreSQL (for Grafana DB)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: neurectomy
          podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432

# Prometheus Network Policy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-network-policy
  namespace: monitoring
  labels:
    app.kubernetes.io/part-of: neurectomy-platform
    network-policy.neurectomy.io/type: monitoring
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Grafana
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - protocol: TCP
          port: 9090
    # Allow from AlertManager
    - from:
        - podSelector:
            matchLabels:
              app: alertmanager
      ports:
        - protocol: TCP
          port: 9090
  egress:
    # Allow scraping all namespaces
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8000 # common metrics port
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 9100 # node-exporter
        - protocol: TCP
          port: 10250 # kubelet
    # Allow AlertManager
    - to:
        - podSelector:
            matchLabels:
              app: alertmanager
      ports:
        - protocol: TCP
          port: 9093
