# ============================================================================
# NEURECTOMY External Secrets Configuration
# Template for integrating with secret management systems
# Supports: AWS Secrets Manager, Azure Key Vault, GCP Secret Manager, HashiCorp Vault
# ============================================================================
#
# PREREQUISITES:
# 1. Install External Secrets Operator:
#    helm repo add external-secrets https://charts.external-secrets.io
#    helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#
# 2. Configure ClusterSecretStore for your cloud provider (examples below)
# ============================================================================

# AWS Secrets Manager ClusterSecretStore
# ---
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: aws-secrets-manager
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: us-east-1
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: external-secrets-sa
#             namespace: external-secrets

# Azure Key Vault ClusterSecretStore
# ---
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: azure-key-vault
# spec:
#   provider:
#     azurekv:
#       tenantId: "<tenant-id>"
#       vaultUrl: "https://<vault-name>.vault.azure.net"
#       authType: WorkloadIdentity
#       serviceAccountRef:
#         name: external-secrets-sa
#         namespace: external-secrets

# GCP Secret Manager ClusterSecretStore
# ---
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: gcp-secret-manager
# spec:
#   provider:
#     gcpsm:
#       projectID: "<project-id>"
#       auth:
#         workloadIdentity:
#           clusterLocation: us-central1
#           clusterName: neurectomy-cluster
#           serviceAccountRef:
#             name: external-secrets-sa
#             namespace: external-secrets

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ml-service-external-secrets
  namespace: neurectomy
  labels:
    app.kubernetes.io/name: ml-service
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: neurectomy-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager # Change based on your cloud provider
  target:
    name: ml-service-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: ml-service
  data:
    - secretKey: database-url
      remoteRef:
        key: neurectomy/ml-service
        property: database-url
    - secretKey: redis-url
      remoteRef:
        key: neurectomy/ml-service
        property: redis-url
    - secretKey: jwt-secret
      remoteRef:
        key: neurectomy/ml-service
        property: jwt-secret
