# =============================================================================
# GraphQL Code Generator Configuration
# =============================================================================
# Multi-language type generation for TypeScript, Rust, and Python.
# Ensures type safety across the entire Neurectomy stack.
# =============================================================================

schema: "./schema/**/*.graphql"
documents: null
config:
  # Global scalar mappings
  scalars:
    UUID: string
    DateTime: string
    JSON: Record<string, unknown>
    Upload: File
    BigInt: string
    Decimal: string
    URL: string
    EmailAddress: string
    Duration: string

generates:
  # ===========================================================================
  # TypeScript Generation
  # ===========================================================================

  # Core TypeScript Types
  ./generated/typescript/types.ts:
    plugins:
      - typescript
      - typescript-operations
    config:
      strictScalars: true
      enumsAsTypes: false
      avoidOptionals: false
      immutableTypes: true
      useTypeImports: true
      skipTypename: false
      declarationKind: interface
      # Additional options for better DX
      maybeValue: T | null | undefined
      inputMaybeValue: T | null | undefined
      namingConvention:
        typeNames: pascal-case#pascalCase
        enumValues: keep
      # Generate helper types
      addUnderscoreToArgsType: true
      # Make enums const for tree-shaking
      constEnums: true

  # TypeScript React Query Hooks
  ./generated/typescript/hooks.ts:
    plugins:
      - typescript
      - typescript-operations
      - typescript-react-query
    config:
      fetcher: graphql-request
      exposeQueryKeys: true
      exposeFetcher: true
      strictScalars: true
      # TanStack Query v5 compatibility
      legacyMode: false
      addInfiniteQuery: true
      addSuspenseQuery: true

  # TypeScript Document Nodes (for Apollo/urql)
  ./generated/typescript/operations.ts:
    plugins:
      - typed-document-node
    config:
      documentMode: documentNode
      # Generate fragment masking helpers
      fragmentMasking: true

  # GraphQL Request SDK (typed client)
  ./generated/typescript/sdk.ts:
    plugins:
      - typescript
      - typescript-operations
      - typescript-graphql-request
    config:
      rawRequest: false
      extensionsType: Record<string, unknown>

  # Schema AST for runtime validation and introspection
  ./generated/typescript/schema.json:
    plugins:
      - introspection
    config:
      minify: false

  # Subscription Types (graphql-ws compatible)
  ./generated/typescript/subscriptions.ts:
    plugins:
      - typescript
      - typescript-operations
    config:
      onlyOperationTypes: true
      strictScalars: true
      # Filter to subscription operations only
      documentMode: documentNode

  # Fragment Types (for fragment matchers)
  ./generated/typescript/fragments.ts:
    plugins:
      - fragment-matcher
    config:
      apolloClientVersion: 3
      useExplicitTyping: true

  # Index file for easy imports
  ./generated/typescript/index.ts:
    plugins:
      - add:
          content: |
            // =============================================================================
            // Auto-generated GraphQL Types - DO NOT EDIT
            // =============================================================================
            // Generated by @graphql-codegen/cli
            // Run 'pnpm run codegen' to regenerate
            // =============================================================================

            export * from './types';
            export * from './hooks';
            export * from './operations';
            export * from './sdk';
            export * from './subscriptions';
            export * from './fragments';

            // Re-export common types for convenience
            export type {
              Agent,
              Workflow,
              Node,
              Message,
              User,
              KnowledgeBase,
              Document,
              Chunk,
            } from './types';

  # ===========================================================================
  # Rust Generation (for rust-core service)
  # ===========================================================================

  # Rust struct definitions
  ../../services/rust-core/src/graphql/generated/types.rs:
    plugins:
      - add:
          content: |
            // =============================================================================
            // Auto-generated GraphQL Types for Rust - DO NOT EDIT
            // =============================================================================
            // Generated by @graphql-codegen/cli with custom Rust template
            // Run 'pnpm run codegen:rust' to regenerate
            // =============================================================================

            #![allow(non_snake_case)]
            #![allow(non_camel_case_types)]
            #![allow(dead_code)]
            #![allow(clippy::all)]

            use serde::{Deserialize, Serialize};
            use std::collections::HashMap;

            // Scalar type aliases
            pub type UUID = String;
            pub type DateTime = chrono::DateTime<chrono::Utc>;
            pub type JSON = serde_json::Value;
            pub type BigInt = i64;
            pub type Decimal = rust_decimal::Decimal;

      - typescript:
          # Note: This generates TS but we'll transform it
          # In production, use a custom Rust plugin
          declarationKind: interface
    config:
      # Configuration for Rust codegen (requires custom plugin in production)
      rustSerde: true
      rustDerive: ["Debug", "Clone", "Serialize", "Deserialize", "PartialEq"]
      rustOptional: Option
      rustVec: Vec

  # Rust mod.rs for module exports
  ../../services/rust-core/src/graphql/generated/mod.rs:
    plugins:
      - add:
          content: |
            // =============================================================================
            // Auto-generated Rust GraphQL module - DO NOT EDIT
            // =============================================================================

            mod types;

            pub use types::*;

  # ===========================================================================
  # Python Generation (for ml-service)
  # ===========================================================================

  # Python Pydantic models
  ../../services/ml-service/src/graphql/generated/types.py:
    plugins:
      - add:
          content: |
            # =============================================================================
            # Auto-generated GraphQL Types for Python - DO NOT EDIT
            # =============================================================================
            # Generated by @graphql-codegen/cli with custom Python template
            # Run 'pnpm run codegen:python' to regenerate
            # =============================================================================

            from __future__ import annotations

            from datetime import datetime
            from decimal import Decimal
            from enum import Enum
            from typing import Any, Dict, List, Optional, Union
            from uuid import UUID

            from pydantic import BaseModel, Field

            # Scalar type aliases
            JSON = Dict[str, Any]
            BigInt = int
            URL = str
            EmailAddress = str
            Duration = str

      - typescript:
          # Note: In production, use a custom Python plugin like graphql-codegen-python
          declarationKind: interface
    config:
      # Configuration for Python codegen
      pythonPydantic: true
      pythonVersion: "3.11"
      pythonOptional: Optional
      pythonList: List

  # Python Strawberry GraphQL types
  ../../services/ml-service/src/graphql/generated/strawberry_types.py:
    plugins:
      - add:
          content: |
            # =============================================================================
            # Auto-generated Strawberry GraphQL Types - DO NOT EDIT
            # =============================================================================
            # For use with Strawberry GraphQL Python framework
            # =============================================================================

            from __future__ import annotations

            import strawberry
            from datetime import datetime
            from decimal import Decimal
            from enum import Enum
            from typing import Any, Dict, List, Optional, Union, NewType
            from uuid import UUID as PyUUID

            # Custom scalar definitions
            UUID = strawberry.scalar(
                NewType("UUID", str),
                serialize=str,
                parse_value=lambda v: v,
            )

            JSON = strawberry.scalar(
                NewType("JSON", dict),
                serialize=lambda v: v,
                parse_value=lambda v: v,
            )

            DateTime = strawberry.scalar(
                NewType("DateTime", datetime),
                serialize=lambda v: v.isoformat(),
                parse_value=lambda v: datetime.fromisoformat(v),
            )

      - typescript:
          declarationKind: interface
    config:
      # Strawberry-specific configuration
      pythonStrawberry: true

  # Python __init__.py for module exports
  ../../services/ml-service/src/graphql/generated/__init__.py:
    plugins:
      - add:
          content: |
            # =============================================================================
            # Auto-generated Python GraphQL module - DO NOT EDIT
            # =============================================================================

            from .types import *
            from .strawberry_types import *

            __all__ = [
                # Export all types
            ]

  # ===========================================================================
  # Schema Documentation (SDL format)
  # ===========================================================================

  # Full merged schema for documentation
  ./generated/schema.graphql:
    plugins:
      - schema-ast
    config:
      includeDirectives: true
      commentDescriptions: true
      sort: true

  # Schema documentation in Markdown
  ../../docs/api/graphql/schema-reference.md:
    plugins:
      - add:
          content: |
            # GraphQL Schema Reference

            > Auto-generated documentation for the Neurectomy GraphQL API.
            > Last updated: ${new Date().toISOString()}

            ## Overview

            This document provides a complete reference for all types, queries,
            mutations, and subscriptions available in the Neurectomy GraphQL API.

            ---

      - schema-ast:
          # Note: In production, use graphql-markdown or similar
          commentDescriptions: true

# =============================================================================
# Hooks
# =============================================================================

hooks:
  # Run after all files are written
  afterAllFileWrite:
    - prettier --write

  # Run after TypeScript generation only
  afterOneFileWrite:
    - cmd: |
        case "$file" in
          *.ts) prettier --write "$file" ;;
          *.rs) rustfmt "$file" 2>/dev/null || true ;;
          *.py) black "$file" 2>/dev/null || true ;;
        esac

# =============================================================================
# Watch Mode Configuration
# =============================================================================

watch:
  # Directories to watch for changes
  - "./schema/**/*.graphql"
# =============================================================================
# Additional Configuration Files
# =============================================================================
# For specific generation targets, create additional config files:
# - codegen.typescript.yml - TypeScript only
# - codegen.rust.yml - Rust only
# - codegen.python.yml - Python only
# =============================================================================
