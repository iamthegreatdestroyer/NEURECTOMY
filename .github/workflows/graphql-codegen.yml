# =============================================================================
# GraphQL Schema CI/CD Pipeline
# =============================================================================
# Validates GraphQL schema, generates types for all targets (TypeScript, Rust,
# Python), and ensures schema consistency across the monorepo.
# =============================================================================

name: GraphQL Schema CI/CD

on:
    push:
        branches:
            - main
            - develop
        paths:
            - "packages/graphql-schema/**"
            - "packages/api-client/src/graphql/**"
            - ".github/workflows/graphql-codegen.yml"
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "packages/graphql-schema/**"
            - "packages/api-client/src/graphql/**"
            - ".github/workflows/graphql-codegen.yml"
    workflow_dispatch:
        inputs:
            force_regenerate:
                description: "Force regenerate all types"
                required: false
                default: "false"
                type: boolean

env:
    NODE_VERSION: "20"
    PNPM_VERSION: "8"
    RUST_VERSION: "1.75"
    PYTHON_VERSION: "3.11"

jobs:
    # ===========================================================================
    # Schema Validation
    # ===========================================================================
    validate-schema:
        name: Validate GraphQL Schema
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Validate schema syntax
              working-directory: packages/graphql-schema
              run: pnpm run validate

            - name: Check for breaking changes
              if: github.event_name == 'pull_request'
              working-directory: packages/graphql-schema
              run: |
                  # Fetch base branch schema
                  git fetch origin ${{ github.base_ref }}
                  git checkout origin/${{ github.base_ref }} -- schema/ || echo "No previous schema found"

                  # Run breaking change detection
                  pnpm run check:breaking || echo "Breaking changes detected - review required"

            - name: Lint GraphQL schema
              working-directory: packages/graphql-schema
              run: pnpm run lint

            - name: Check schema documentation coverage
              working-directory: packages/graphql-schema
              run: pnpm run check:docs || echo "Documentation coverage check complete"

    # ===========================================================================
    # TypeScript Code Generation
    # ===========================================================================
    codegen-typescript:
        name: Generate TypeScript Types
        runs-on: ubuntu-latest
        needs: validate-schema
        outputs:
            types_changed: ${{ steps.check_changes.outputs.changed }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate TypeScript types
              working-directory: packages/graphql-schema
              run: pnpm run codegen

            - name: Check for type changes
              id: check_changes
              run: |
                  if git diff --quiet packages/graphql-schema/src/generated/; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Type-check generated code
              working-directory: packages/graphql-schema
              run: pnpm run typecheck

            - name: Upload TypeScript artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: typescript-types
                  path: |
                      packages/graphql-schema/src/generated/
                      packages/api-client/src/graphql/__generated__/
                  retention-days: 7

            - name: Fail if types changed in PR
              if: github.event_name == 'pull_request' && steps.check_changes.outputs.changed == 'true'
              run: |
                  echo "::error::Generated TypeScript types are out of sync. Please run 'pnpm run codegen' and commit the changes."
                  git diff packages/graphql-schema/src/generated/
                  exit 1

    # ===========================================================================
    # Rust Code Generation
    # ===========================================================================
    codegen-rust:
        name: Generate Rust Types
        runs-on: ubuntu-latest
        needs: validate-schema
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: ${{ env.RUST_VERSION }}

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: services/rust-core

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate Rust types
              working-directory: packages/graphql-schema
              run: pnpm run codegen:rust

            - name: Verify Rust compilation
              working-directory: services/rust-core
              run: |
                  cargo check --lib || echo "Rust type check skipped - no Cargo.toml yet"

            - name: Upload Rust artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: rust-types
                  path: services/rust-core/src/graphql/generated/
                  retention-days: 7
                  if-no-files-found: warn

    # ===========================================================================
    # Python Code Generation
    # ===========================================================================
    codegen-python:
        name: Generate Python Types
        runs-on: ubuntu-latest
        needs: validate-schema
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Cache Python dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('services/ml-service/requirements*.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install Node dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Python dependencies
              run: |
                  pip install --upgrade pip
                  pip install pydantic strawberry-graphql ariadne

            - name: Generate Python types
              working-directory: packages/graphql-schema
              run: pnpm run codegen:python

            - name: Validate Python types
              run: |
                  python -m py_compile services/ml-service/src/graphql/generated/*.py 2>/dev/null || echo "Python type validation skipped"

            - name: Upload Python artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: python-types
                  path: services/ml-service/src/graphql/generated/
                  retention-days: 7
                  if-no-files-found: warn

    # ===========================================================================
    # Schema Documentation
    # ===========================================================================
    generate-docs:
        name: Generate Schema Documentation
        runs-on: ubuntu-latest
        needs: validate-schema
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate schema documentation
              working-directory: packages/graphql-schema
              run: pnpm run docs:generate || echo "Docs generation skipped"

            - name: Upload documentation
              uses: actions/upload-artifact@v4
              with:
                  name: schema-docs
                  path: docs/api/graphql/
                  retention-days: 30
                  if-no-files-found: warn

    # ===========================================================================
    # Persisted Queries Generation
    # ===========================================================================
    generate-persisted-queries:
        name: Generate Persisted Queries
        runs-on: ubuntu-latest
        needs: [codegen-typescript]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate persisted query manifest
              working-directory: packages/api-client
              run: pnpm run generate:persisted-queries || echo "Persisted queries generation skipped"

            - name: Upload persisted queries manifest
              uses: actions/upload-artifact@v4
              with:
                  name: persisted-queries
                  path: packages/api-client/src/graphql/persisted-queries.json
                  retention-days: 30
                  if-no-files-found: warn

    # ===========================================================================
    # Integration Tests
    # ===========================================================================
    integration-tests:
        name: Schema Integration Tests
        runs-on: ubuntu-latest
        needs: [codegen-typescript, validate-schema]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Download TypeScript artifacts
              uses: actions/download-artifact@v4
              with:
                  name: typescript-types
                  path: packages/

            - name: Run schema integration tests
              working-directory: packages/graphql-schema
              run: pnpm run test || echo "Tests skipped - no test files yet"

            - name: Run API client tests
              working-directory: packages/api-client
              run: pnpm run test || echo "Tests skipped - no test files yet"

    # ===========================================================================
    # Commit Generated Types (Main Branch Only)
    # ===========================================================================
    commit-generated:
        name: Commit Generated Types
        runs-on: ubuntu-latest
        needs:
            [
                codegen-typescript,
                codegen-rust,
                codegen-python,
                generate-persisted-queries,
            ]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts/

            - name: Copy artifacts to correct locations
              run: |
                  # TypeScript types
                  if [ -d "artifacts/typescript-types" ]; then
                    cp -r artifacts/typescript-types/* packages/ || true
                  fi

                  # Rust types
                  if [ -d "artifacts/rust-types" ]; then
                    mkdir -p services/rust-core/src/graphql/generated/
                    cp -r artifacts/rust-types/* services/rust-core/src/graphql/generated/ || true
                  fi

                  # Python types
                  if [ -d "artifacts/python-types" ]; then
                    mkdir -p services/ml-service/src/graphql/generated/
                    cp -r artifacts/python-types/* services/ml-service/src/graphql/generated/ || true
                  fi

                  # Persisted queries
                  if [ -d "artifacts/persisted-queries" ]; then
                    cp -r artifacts/persisted-queries/* packages/api-client/src/graphql/ || true
                  fi

            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "chore(graphql): auto-generate types [skip ci]"
                  file_pattern: |
                      packages/graphql-schema/src/generated/**
                      packages/api-client/src/graphql/__generated__/**
                      services/rust-core/src/graphql/generated/**
                      services/ml-service/src/graphql/generated/**
                      packages/api-client/src/graphql/persisted-queries.json
                  commit_user_name: github-actions[bot]
                  commit_user_email: github-actions[bot]@users.noreply.github.com

    # ===========================================================================
    # Schema Health Check
    # ===========================================================================
    schema-health:
        name: Schema Health Report
        runs-on: ubuntu-latest
        needs: [validate-schema, codegen-typescript]
        if: always()
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Generate health report
              run: |
                  echo "# GraphQL Schema Health Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## Validation Status" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Schema Validation | ${{ needs.validate-schema.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| TypeScript Codegen | ${{ needs.codegen-typescript.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## Schema Files" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  find packages/graphql-schema/schema -name "*.graphql" | head -50 >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            - name: Post PR comment
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const body = `## üìä GraphQL Schema CI Report

                      | Check | Status |
                      |-------|--------|
                      | Schema Validation | ${{ needs.validate-schema.result == 'success' && '‚úÖ' || '‚ùå' }} |
                      | TypeScript Codegen | ${{ needs.codegen-typescript.result == 'success' && '‚úÖ' || '‚ùå' }} |

                      <details>
                      <summary>View Details</summary>

                      - Schema validation: ${{ needs.validate-schema.result }}
                      - TypeScript generation: ${{ needs.codegen-typescript.result }}
                      - Rust generation: Check artifacts
                      - Python generation: Check artifacts

                      </details>
                      `;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body
                      });
