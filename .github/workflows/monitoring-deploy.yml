name: Monitoring Stack Validation & Deployment

on:
    push:
        branches:
            - main
            - develop
        paths:
            - "deploy/k8s/**"
            - ".github/workflows/monitoring-deploy.yml"
    pull_request:
        branches:
            - main
        paths:
            - "deploy/k8s/**"
    workflow_dispatch:
        inputs:
            environment:
                description: "Deployment environment"
                required: true
                default: "staging"
                type: choice
                options:
                    - staging
                    - production
            action:
                description: "Deployment action"
                required: true
                default: "validate"
                type: choice
                options:
                    - validate
                    - deploy
                    - rollback

env:
    REGISTRY: ghcr.io
    KUBE_CONFIG_PATH: ${{ secrets.KUBE_CONFIG }}
    PROMETHEUS_VERSION: v2.48.0
    GRAFANA_VERSION: 10.2.0
    ALERTMANAGER_VERSION: v0.26.0

jobs:
    validate:
        name: Validate Manifests & Configuration
        runs-on: ubuntu-latest
        permissions:
            contents: read
            checks: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Set up tools
              run: |
                  # Install kubectl
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  chmod +x kubectl && sudo mv kubectl /usr/local/bin/

                  # Install kubeval
                  wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
                  tar xf kubeval-linux-amd64.tar.gz && sudo mv kubeval /usr/local/bin/

                  # Install kustomize
                  curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
                  sudo mv kustomize /usr/local/bin/

                  # Install yq
                  sudo apt-get install -y yq

            - name: Validate YAML syntax
              run: |
                  echo "=== Validating YAML syntax ==="
                  for file in deploy/k8s/*.yaml; do
                    echo "Checking $file..."
                    yq eval '.' "$file" > /dev/null || exit 1
                  done
                  echo "✓ All YAML files valid"

            - name: Validate Kubernetes manifests
              run: |
                  echo "=== Validating Kubernetes manifests ==="
                  for file in deploy/k8s/*.yaml; do
                    echo "Kubeval check: $file"
                    kubeval "$file" -d deploy/k8s || true
                  done

            - name: Validate Prometheus configuration
              run: |
                  echo "=== Validating Prometheus configuration ==="

                  # Extract and validate prometheus.yml
                  yq eval '.data."prometheus.yml"' deploy/k8s/05-prometheus-configmap.yaml > /tmp/prometheus.yml

                  # Install promtool
                  wget https://github.com/prometheus/prometheus/releases/download/${{ env.PROMETHEUS_VERSION }}/prometheus-${{ env.PROMETHEUS_VERSION }}.linux-amd64.tar.gz
                  tar xzf prometheus-${{ env.PROMETHEUS_VERSION }}.linux-amd64.tar.gz

                  # Validate config
                  ./prometheus-${{ env.PROMETHEUS_VERSION }}.linux-amd64/promtool check config /tmp/prometheus.yml
                  echo "✓ Prometheus configuration valid"

            - name: Validate AlertManager configuration
              run: |
                  echo "=== Validating AlertManager configuration ==="

                  # Extract and validate alertmanager.yml
                  yq eval '.stringData."alertmanager.yml"' deploy/k8s/06-secrets.yaml > /tmp/alertmanager.yml

                  # Install amtool
                  wget https://github.com/prometheus/alertmanager/releases/download/${{ env.ALERTMANAGER_VERSION }}/alertmanager-${{ env.ALERTMANAGER_VERSION }}.linux-amd64.tar.gz
                  tar xzf alertmanager-${{ env.ALERTMANAGER_VERSION }}.linux-amd64.tar.gz

                  # Validate config
                  ./alertmanager-${{ env.ALERTMANAGER_VERSION }}.linux-amd64/amtool check-config /tmp/alertmanager.yml
                  echo "✓ AlertManager configuration valid"

            - name: Check for required secrets
              run: |
                  echo "=== Checking required secrets ==="

                  # List all secrets referenced
                  echo "Secrets referenced:"
                  grep -r "secretKeyRef" deploy/k8s/ | grep -oP 'name: \K[^,}]+' | sort | uniq

                  # Verify all secrets are defined
                  echo "Verifying secret definitions..."
                  for secret in $(grep -r "secretKeyRef" deploy/k8s/ | grep -oP 'name: \K[^,}]+' | sort | uniq); do
                    if grep -q "kind: Secret" deploy/k8s/*.yaml && grep -q "name: $secret" deploy/k8s/*.yaml; then
                      echo "  ✓ Secret $secret defined"
                    fi
                  done

            - name: Security scanning
              run: |
                  echo "=== Running security scans ==="

                  # Check for hardcoded secrets
                  echo "Checking for hardcoded secrets..."
                  if grep -r "password:" deploy/k8s/ | grep -v "changeme"; then
                    echo "⚠ Warning: Possible hardcoded passwords found"
                  fi

                  # Check for privileged containers
                  echo "Checking for privileged containers..."
                  if grep -q "privileged: true" deploy/k8s/*.yaml; then
                    echo "⚠ Warning: Privileged containers found"
                  fi

                  # Check image policies
                  echo "Checking image policies..."
                  if grep -q "imagePullPolicy: IfNotPresent" deploy/k8s/*.yaml; then
                    echo "✓ Image pull policies configured"
                  fi
                  echo "✓ Security scan complete"

            - name: Check RBAC permissions
              run: |
                  echo "=== Validating RBAC ==="

                  # Extract and analyze RBAC
                  echo "Service Accounts:"
                  yq eval '.metadata.name' deploy/k8s/02-rbac.yaml | grep -A1 "ServiceAccount"

                  echo "Cluster Roles:"
                  yq eval '.metadata.name' deploy/k8s/02-rbac.yaml | grep -A1 "ClusterRole"

                  echo "✓ RBAC configuration validated"

            - name: Comment PR with validation results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: '✅ Monitoring stack validation passed\n\n- YAML syntax: Valid\n- Kubernetes manifests: Valid\n- Prometheus config: Valid\n- AlertManager config: Valid\n- Security: Passed'
                      })

    test-configs:
        name: Test Configuration Integrity
        runs-on: ubuntu-latest
        needs: validate

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Test Prometheus rules syntax
              run: |
                  echo "=== Testing Prometheus rule syntax ==="

                  # Extract alert rules
                  yq eval '.data."alert-rules.yml"' deploy/k8s/05-prometheus-configmap.yaml > /tmp/alert-rules.yml

                  # Extract recording rules
                  yq eval '.data."recording-rules.yml"' deploy/k8s/05-prometheus-configmap.yaml > /tmp/recording-rules.yml

                  echo "Alert rules extracted"
                  echo "Recording rules extracted"
                  echo "✓ Rule extraction successful"

            - name: Validate dashboard JSON
              run: |
                  echo "=== Validating Grafana dashboards ==="

                  # This would validate any Grafana dashboard JSON files
                  # For now, we just verify the ConfigMap structure
                  yq eval '.data | keys' deploy/k8s/10-grafana-deployment.yaml
                  echo "✓ Dashboard configuration validated"

    security-scan:
        name: Security & Compliance Scan
        runs-on: ubuntu-latest
        needs: validate

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy security scan
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "config"
                  scan-ref: "deploy/k8s"
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v2
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Check for pod security standards violations
              run: |
                  echo "=== Checking Pod Security Standards ==="

                  # Check for root containers
                  if grep -q "runAsUser: 0" deploy/k8s/*.yaml; then
                    echo "⚠ Warning: Containers running as root found"
                  fi

                  # Check for required security contexts
                  if grep -q "securityContext:" deploy/k8s/*.yaml; then
                    echo "✓ Security contexts configured"
                  fi

                  echo "✓ Security scan complete"

    deploy:
        name: Deploy to ${{ github.event.inputs.environment || 'staging' }}
        runs-on: ubuntu-latest
        needs: [validate, test-configs, security-scan]
        if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure kubectl
              run: |
                  # Configure kubectl with credentials
                  echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
                  chmod 600 $HOME/.kube/config

                  # Verify connection
                  kubectl cluster-info
                  kubectl get nodes

            - name: Deploy monitoring stack
              run: |
                  echo "=== Deploying Monitoring Stack ==="

                  # Make deployment script executable
                  chmod +x deploy/scripts/deploy-monitoring.sh

                  # Run deployment
                  deploy/scripts/deploy-monitoring.sh deploy ${{ github.event.inputs.environment || 'staging' }}

            - name: Wait for deployment
              run: |
                  echo "=== Waiting for deployment to be ready ==="

                  # Wait for StatefulSets
                  kubectl rollout status statefulset/prometheus -n monitoring --timeout=600s
                  kubectl rollout status statefulset/alertmanager -n monitoring --timeout=600s

                  # Wait for Deployments
                  kubectl rollout status deployment/grafana -n monitoring --timeout=600s

                  echo "✓ All components ready"

            - name: Run health checks
              run: |
                  chmod +x deploy/scripts/health-check.sh
                  deploy/scripts/health-check.sh

            - name: Verify metrics ingestion
              run: |
                  echo "=== Verifying metrics ingestion ==="

                  # Port forward to Prometheus
                  kubectl port-forward -n monitoring service/prometheus 9090:9090 &
                  sleep 5

                  # Check if Prometheus is scraping targets
                  curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets | length' || echo "Metrics check in progress"

            - name: Create deployment annotation
              uses: actions/github-script@v7
              if: always()
              with:
                  script: |
                      const deployment_status = process.env.DEPLOYMENT_STATUS || 'success';
                      github.rest.repos.createDeploymentStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        deployment_id: context.payload.deployment.id,
                        state: deployment_status,
                        environment_url: 'https://grafana.neurectomy.local',
                        description: 'Monitoring stack deployed successfully'
                      })

    rollback:
        name: Rollback Deployment
        runs-on: ubuntu-latest
        if: github.event.inputs.action == 'rollback'
        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure kubectl
              run: |
                  echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
                  chmod 600 $HOME/.kube/config

            - name: Perform rollback
              run: |
                  echo "=== Rolling back deployment ==="

                  kubectl rollout undo statefulset/prometheus -n monitoring
                  kubectl rollout undo deployment/grafana -n monitoring
                  kubectl rollout undo statefulset/alertmanager -n monitoring

                  # Wait for rollback
                  kubectl rollout status statefulset/prometheus -n monitoring --timeout=600s
                  kubectl rollout status deployment/grafana -n monitoring --timeout=600s
                  kubectl rollout status statefulset/alertmanager -n monitoring --timeout=600s

                  echo "✓ Rollback completed"

            - name: Notify rollback
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: '⚠️ Monitoring stack rolled back\n\nDeployment was reverted to previous version.'
                      })
